<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Magellan by harsha2010</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Magellan</h1>
      <h2 class="project-tagline">Geo Spatial Data Analytics on Spark</h2>
      <a href="https://github.com/harsha2010/magellan" class="btn">View on GitHub</a>
      <a href="https://github.com/harsha2010/magellan/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/harsha2010/magellan/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="magellan-geospatial-analytics-using-spark" class="anchor" href="#magellan-geospatial-analytics-using-spark" aria-hidden="true"><span class="octicon octicon-link"></span></a>Magellan: Geospatial Analytics Using Spark</h1>

<p>Geospatial data is pervasive, and spatial context is a very rich signal of user intent and relevance
in search and targeted advertising and an important variable in many predictive analytics applications.
For example when a user searches for “canyon hotels”, without location awareness the top result
or sponsored ads might be for hotels in the town “Canyon, TX”.
However, if they are are near the Grand Canyon, the top results or ads should be for nearby hotels.
Thus a search term combined with location context allows for much more relevant results and ads.
Similarly a variety of other predictive analytics problems can leverage location as a context.</p>

<p>To leverage spatial context in a predictive analytics application requires us to be able
to parse these datasets at scale, join them with target datasets that contain point in space information,
and answer geometrical queries efficiently.</p>

<p>Magellan is an open source library Geospatial Analytics using Spark as the underlying engine.
We leverage Catalyst’s pluggable optimizer to efficiently execute spatial joins, SparkSQL’s powerful operators to express geometric queries in a natural DSL, and Pyspark’s Python integration to provide Python bindings.</p>

<h1>
<a id="linking" class="anchor" href="#linking" aria-hidden="true"><span class="octicon octicon-link"></span></a>Linking</h1>

<p>You can link against this library using the following coordinates:</p>

<pre><code>groupId: org.apache
artifactId: magellan
version: 1.0.0
</code></pre>

<h1>
<a id="requirements" class="anchor" href="#requirements" aria-hidden="true"><span class="octicon octicon-link"></span></a>Requirements</h1>

<p>This library requires Spark 1.3+</p>

<h1>
<a id="capabilities" class="anchor" href="#capabilities" aria-hidden="true"><span class="octicon octicon-link"></span></a>Capabilities</h1>

<p>The library currently supports the <a href="https://www.esri.com/library/whitepapers/pdfs/shapefile.pdf">ESRI</a> format files.</p>

<p>We aim to support the full suite of <a href="http://www.opengeospatial.org/standards/sfs">OpenGIS Simple Features for SQL </a> spatial predicate functions and operators together with additional topological functions.</p>

<p>capabilities include:</p>

<p><strong>Geometries</strong>: Point, LineString, Polygon, MultiPoint, MultiLineString, MultiPolygon, GeometryCollection</p>

<p><strong>Predicates</strong>: Intersects, Touches, Disjoint, Crosses, Within, Contains, Overlaps, Equals, Covers</p>

<p><strong>Operations</strong>: Union, Distance, Intersection, Symmetric Difference, Convex Hull, Envelope, Buffer, Simplify, Valid, Area, Length</p>

<p><strong>Scala and Python API</strong></p>

<h1>
<a id="examples" class="anchor" href="#examples" aria-hidden="true"><span class="octicon octicon-link"></span></a>Examples</h1>

<h2>
<a id="reading-data" class="anchor" href="#reading-data" aria-hidden="true"><span class="octicon octicon-link"></span></a>Reading Data</h2>

<p>You can read data as follows:</p>

<pre><code>val df = sqlCtx.load("org.apache.magellan", path)
df.show()

+-----+--------+--------------------+--------------------+-----+
|point|polyline|             polygon|            metadata|valid|
+-----+--------+--------------------+--------------------+-----+
| null|    null|Polygon(5, Vector...|Map(neighborho -&gt;...| true|
| null|    null|Polygon(5, Vector...|Map(neighborho -&gt;...| true|
| null|    null|Polygon(5, Vector...|Map(neighborho -&gt;...| true|
| null|    null|Polygon(5, Vector...|Map(neighborho -&gt;...| true|
+-----+--------+--------------------+--------------------+-----+

df.select(df.metadata['neighborho']).show()

+--------------------+
|metadata[neighborho]|
+--------------------+
|Twin Peaks       ...|
|Pacific Heights  ...|
|Visitacion Valley...|
|Potrero Hill     ...|
+--------------------+
</code></pre>

<h1>
<a id="operations" class="anchor" href="#operations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Operations</h1>

<h2>
<a id="expressions" class="anchor" href="#expressions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Expressions</h2>

<h3>
<a id="point" class="anchor" href="#point" aria-hidden="true"><span class="octicon octicon-link"></span></a>point</h3>

<p>This is a convenience function for creating a point from two expressions, or two literals as the case may be.</p>

<pre><code>from magellan.types import Point
from pyspark.sql import Row, SQLContext

Record = Row("id", "point")
df = sc.parallelize([(0, Point(1.0, 1.0)),
                     (1, Point(1.0, 2.0)),
                     (2, Point(-1.5, 1.5)),
                     (3, Point(3.5, 0.0))]) \
.map(lambda x: Record(*x)).toDF()

df.show()

+---+----------+
| id|     point|
+---+----------+
|  0| [1.0,1.0]|
|  1| [1.0,2.0]|
|  2|[-1.5,1.5]|
|  3| [3.5,0.0]|
+---+----------+
</code></pre>

<p>Similar UDFs exist for line, polygon, polyline etc.</p>

<h2>
<a id="predicates" class="anchor" href="#predicates" aria-hidden="true"><span class="octicon octicon-link"></span></a>Predicates</h2>

<h3>
<a id="within" class="anchor" href="#within" aria-hidden="true"><span class="octicon octicon-link"></span></a>within</h3>

<pre><code>PointRecord = Row("id", "point")
pointdf = sc.parallelize([(0, Point(1.0, 1.0)),
                           (1, Point(1.0, 2.0)),
                           (2, Point(-1.5, 1.5)),
                           (3, Point(3.5, 0.0))]) \
            .map(lambda x: PointRecord(*x)).toDF()

PolygonRecord = Row("id", "polygon")
polygondf = sc.parallelize([
                (0, Polygon([0],    [Point(2.5, 2.5), Point(2.5, 2.75), Point(2.75, 2.75), Point(2.5, 2.5)])),
                (1, Polygon([0], [Point(0.5, 0.5), Point(0.5, 0.75), Point(0.75, 0.75), Point(0.5, 0.5)])),
                (2, Polygon([0], [Point(0.0, 0.0), Point(0.0, 1.0), Point(1.0, 1.0), Point(1.0, 0.0), Point(0.0, 0.0)]))]) \
                 .map(lambda x: PolygonRecord(*x)).toDF()

from magellan.column import within
from pyspark.sql.functions import col

pointdf.join(polygondf).where(col("point").within(col("polygon"))).show()

+--+-----+--+-------+
|id|point|id|polygon|
+--+-----+--+-------+
+--+-----+--+-------+
</code></pre>

<p>This agrees with our expectation: The point 1,1 is on the boundary of one of the polygons, but that is not the same as being within the polygon.</p>

<h3>
<a id="intersects" class="anchor" href="#intersects" aria-hidden="true"><span class="octicon octicon-link"></span></a>intersects</h3>

<pre><code>pointdf.join(polygondf).where(col("point").intersects(col("polygon"))).show()   

+--+-----------+--+--------------------+
|id|      point|id|             polygon|
+--+-----------+--+--------------------+
| 0|[1,1.0,1.0]| 2|[5,ArrayBuffer(0)...|
+--+-----------+--+--------------------+
</code></pre>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/harsha2010/magellan">Magellan</a> is maintained by <a href="https://github.com/harsha2010">harsha2010</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>

